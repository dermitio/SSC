<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" id="favicon" href="/favicon.png?v=1">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Private Chat</title>

<style>
:root {
  --bg: #0f0f10;
  --panel: #161618;
  --border: #26262a;
  --text: #eaeaea;
  --muted: #9a9aa0;
  --accent: #4da3ff;
}

* { box-sizing: border-box; }

html, body {
  margin: 0;
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

#app {
  height: 100%;
  display: flex;
  flex-direction: column;
}

#log {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.msg {
  max-width: 85%;
  padding: 8px 12px;
  border-radius: 10px;
  background: var(--panel);
  border: 1px solid var(--border);
  word-wrap: break-word;
}

.msg.me {
  align-self: flex-end;
  background: #1d2735;
  border-color: #2b3c55;
}

.msg .name {
  font-size: 0.75em;
  color: var(--muted);
  margin-bottom: 2px;
}

.system {
  align-self: center;
  font-size: 0.8em;
  color: var(--muted);
}

#input-bar {
  display: flex;
  gap: 8px;
  padding: 10px;
  border-top: 1px solid var(--border);
  background: var(--panel);
}

#msg {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: #0b0b0c;
  color: var(--text);
  font-size: 16px;
}

button {
  padding: 0 16px;
  border-radius: 8px;
  border: none;
  background: var(--accent);
  color: black;
  font-weight: 600;
  font-size: 16px;
}

button:active { opacity: 0.85; }

#record { padding: 0 12px; font-size: 18px; }
#attach { padding: 0 12px; font-size: 18px; }
.dlbtn { padding: 0 10px; font-size: 16px; }
</style>
</head>

<div id="recPopup" style="
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: #161618;
  border: 1px solid #26262a;
  border-radius: 12px;
  padding: 12px 16px;
  display: none;
  align-items: center;
  gap: 12px;
  z-index: 9999;
">
  <span id="recDot" style="color:red;font-weight:bold">â— REC</span>
  <span id="recTime">00:00</span>
  <button id="recStop" style="margin-left:12px">Stop</button>
</div>

<body>
<div id="app">
  <div id="log"></div>

  <div id="input-bar">
    <button id="record" title="Hold to record">ğŸ¤</button>
    <button id="attach" title="Upload file">ğŸ“</button>
    <input id="msg" placeholder="Messageâ€¦" autocomplete="off" />
    <button id="sendBtn">Send</button>
  </div>

  <input type="file" id="fileInput" style="display:none" />
</div>

<script>
const log = document.getElementById("log");
const input = document.getElementById("msg");
const recordBtn = document.getElementById("record");
const attachBtn = document.getElementById("attach");
const sendBtn = document.getElementById("sendBtn");
const fileInput = document.getElementById("fileInput");
const favicon = document.getElementById("favicon");

let loadingHistory = true;
let unreadCount = 0;
const originalTitle = document.title;

// Username
let name = localStorage.getItem("name");
if (!name) {
  name = prompt("Your name?");
  localStorage.setItem("name", name);
}

// Notifications
if ("Notification" in window && Notification.permission === "default") {
  Notification.requestPermission();
}

function clearUnread() {
  unreadCount = 0;
  document.title = originalTitle;
  favicon.href = "/favicon.png?v=1";
}

window.addEventListener("focus", clearUnread);
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") clearUnread();
});

function isTabInactive() {
  return document.visibilityState !== "visible" || !document.hasFocus();
}

// WebSocket
const ws = new WebSocket(`wss://${location.host}`);

ws.onmessage = e => {
  const data = JSON.parse(e.data);
  if (data.system && data.history) {
    data.history.forEach(render);
    loadingHistory = false;
    return;
  }
  render(data);
};

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadFile(url, filename) {
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

async function uploadAudio(blob) {
  const filename = `audio_${Date.now()}.webm`;

  let res;
  try {
    res = await fetch(
      `/audio/upload?name=${encodeURIComponent(filename)}`,
      {
        method: "POST",
        body: blob
      }
    );
  } catch (err) {
    console.error("Audio upload network error:", err);
    alert("Audio upload failed (network error)");
    return;
  }

  if (!res.ok) {
    const text = await res.text();
    console.error("Audio upload failed:", text);
    alert("Audio upload failed: " + text);
    return;
  }

  let json;
  try {
    json = await res.json();
  } catch {
    alert("Audio upload failed (invalid server response)");
    return;
  }

  const saved = json.filename;

  ws.send(JSON.stringify({
    name,
    type: "audio",
    audio: {
      name: saved,
      url: `/audio/${saved}`
    }
  }));
}

function fileIconFor(ext) {
  const map = {
    pdf: "ğŸ“•",
    zip: "ğŸ—œï¸",
    rar: "ğŸ—œï¸",
    jar: "ğŸ—œï¸",
    "7z": "ğŸ—œï¸",
    txt: "ğŸ“„",
    md: "ğŸ“„",
    json: "ğŸ§¾",
    js: "ğŸ“œ",
    html: "ğŸŒ",
    css: "ğŸ¨",
    mp3: "ğŸµ",
    wav: "ğŸµ",
    flac: "ğŸµ",
    ogg: "ğŸµ",
    mp4: "ğŸï¸",
    webm: "ğŸï¸",
    mov: "ğŸï¸",
    exe: "âš™ï¸",
    apk: "ğŸ“¦"
  };
  return map[ext] || "ğŸ“";
}

// â”€â”€â”€ RECORDING UI STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const recPopup = document.getElementById("recPopup");
const recTimeEl = document.getElementById("recTime");
const recStopBtn = document.getElementById("recStop");

let recorder = null;
let audioChunks = [];
let audioStream = null;
let recStartTs = 0;
let recTimer = null;

function fmtTime(ms) {
  const s = Math.floor(ms / 1000);
  const m = Math.floor(s / 60);
  return `${String(m).padStart(2,"0")}:${String(s % 60).padStart(2,"0")}`;
}

async function startRecording() {
  if (recorder) return;

  try {
    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch {
    alert("Microphone permission denied");
    return;
  }

  const mime = MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
    ? "audio/webm;codecs=opus"
    : "audio/webm";

  recorder = new MediaRecorder(audioStream, { mimeType: mime });
  audioChunks = [];

  recorder.ondataavailable = e => {
    if (e.data && e.data.size > 0) audioChunks.push(e.data);
  };

  recorder.onstop = async () => {
    clearInterval(recTimer);
    recPopup.style.display = "none";

    const blob = new Blob(audioChunks, { type: recorder.mimeType });

    console.log("Recorded blob size:", blob.size);

    if (blob.size === 0) {
      alert("Recording failed (0 bytes)");
    } else {
      await uploadAudio(blob);
    }

    audioStream.getTracks().forEach(t => t.stop());
    recorder = null;
    audioStream = null;
    audioChunks = [];
  };

  recorder.start();

  // UI
  recStartTs = Date.now();
  recTimeEl.textContent = "00:00";
  recPopup.style.display = "flex";

  recTimer = setInterval(() => {
    recTimeEl.textContent = fmtTime(Date.now() - recStartTs);
  }, 250);
}

function stopRecording() {
  if (!recorder) return;
  recorder.stop();
}

// Bind buttons ONCE
recordBtn.onmousedown = startRecording;
recordBtn.onmouseup = stopRecording;
recordBtn.onmouseleave = stopRecording;

recordBtn.ontouchstart = e => { e.preventDefault(); startRecording(); };
recordBtn.ontouchend = e => { e.preventDefault(); stopRecording(); };

recStopBtn.onclick = stopRecording;

// â”€â”€â”€ FILE UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
attachBtn.onclick = () => fileInput.click();

fileInput.onchange = async () => {
  const file = fileInput.files[0];
  if (!file) return;

  const res = await fetch(`/files/upload?name=${encodeURIComponent(file.name)}`, {
    method: "POST",
    body: file
  });

  if (!res.ok) {
    const text = await res.text();
    alert("Upload failed: " + text);
    fileInput.value = "";
    return;
  }

  const { filename } = await res.json();

  ws.send(JSON.stringify({
    name,
    type: "file",
    file: { name: filename, url: `/files/${filename}` }
  }));

  fileInput.value = "";
};

// â”€â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(data) {
  const div = document.createElement("div");

  if (data.system) {
    div.className = "system";
    div.textContent = data.msg;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
    return;
  }

  div.className = "msg" + (data.name === name ? " me" : "");

  // AUDIO
  if (data.type === "audio" && data.audio) {
    div.innerHTML = `
      <div class="name">${data.name}</div>
      <audio controls src="${data.audio.url}" style="width:100%"></audio>
    `;
  }

  // FILE
  else if (data.type === "file" && data.file) {
    const fname = data.file.name;
    const url = data.file.url;
    const ext = fname.includes(".") ? fname.split(".").pop().toLowerCase() : "";

    if (["png","jpg","jpeg","gif","webp","bmp"].includes(ext)) {
      div.innerHTML = `
        <div class="name">${data.name}</div>
        <img src="${url}" style="max-width:100%;border-radius:8px" />
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:0.8em;color:var(--muted)">${fname}</span>
          <button class="dlbtn" onclick="downloadFile('${url}','${fname}')">â¬‡ï¸</button>
        </div>
      `;
    } else if (["mp4","webm","ogg","mov"].includes(ext)) {
      div.innerHTML = `
        <div class="name">${data.name}</div>
        <video src="${url}" controls preload="metadata"
          style="max-width:100%;border-radius:8px"></video>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span style="font-size:0.8em;color:var(--muted)">${fname}</span>
          <button class="dlbtn" onclick="downloadFile('${url}','${fname}')">â¬‡ï¸</button>
        </div>
      `;
    } else {
      const icon = fileIconFor(ext);
      div.innerHTML = `
        <div class="name">${data.name}</div>
        <div style="display:flex;align-items:center;gap:10px">
          <span style="font-size:24px">${icon}</span>
          <span style="flex:1">${fname}</span>
          <button class="dlbtn" onclick="downloadFile('${url}','${fname}')">â¬‡ï¸</button>
        </div>
      `;
    }
  }

  // TEXT
  else {
    div.innerHTML = `
      <div class="name">${data.name}</div>
      <div>${(data.msg ?? "").toString()}</div>
    `;
  }

  // notifications
  if (!loadingHistory && data.name !== name && isTabInactive() && Notification.permission === "granted") {
    unreadCount++;
    document.title = `(${unreadCount}) New message`;
    favicon.href = "/favicon-unread.png?v=1";

    const preview =
      data.type === "file" ? `ğŸ“ ${data.file?.name || "file"}`
      : data.type === "audio" ? "ğŸ¤ voice message"
      : (data.msg || "").slice(0, 120);

    const n = new Notification(`New message from ${data.name}`, { body: preview, silent: true });
    n.onclick = () => { window.focus(); n.close(); };
  }

  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}


// â”€â”€â”€ SEND TEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function send() {
  if (!input.value.trim()) return;
  ws.send(JSON.stringify({ name, msg: input.value }));
  input.value = "";
}

sendBtn.onclick = send;
input.addEventListener("keydown", e => { if (e.key === "Enter") send(); });


</script>
</body>
</html>

